<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MVL Benchmark Generator</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #d97707;
            --primary-light: #f59e0b;
            --primary-dark: #b45309;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --bg-page: #fffbeb;
            --bg-white: #ffffff;
            --bg-gray: #fef3c7;
            --border: #fde68a;
            --border-focus: #f59e0b;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --text-muted: #94a3b8;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --radius: 8px;
            --radius-lg: 12px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-page);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.5;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            padding: 32px 24px;
            text-align: center;
        }

        .header h1 {
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .header p {
            font-size: 0.95rem;
            opacity: 0.9;
        }

        /* Container */
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 24px;
        }

        /* Card */
        .card {
            background: var(--bg-white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            padding: 24px;
            margin-bottom: 20px;
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border);
        }

        .card-icon {
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .card-subtitle {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        /* Form Elements */
        .form-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-row-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .form-row, .form-row-3 {
                grid-template-columns: 1fr;
            }
        }

        .form-group {
            margin-bottom: 0;
        }

        .form-group label {
            display: block;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-group .hint {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 6px;
        }

        /* Select */
        .select-wrapper {
            position: relative;
        }

        .select-wrapper::after {
            content: '';
            position: absolute;
            right: 14px;
            top: 50%;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            border-top: 5px solid var(--text-secondary);
            pointer-events: none;
        }

        select {
            width: 100%;
            padding: 12px 40px 12px 14px;
            background: var(--bg-white);
            border: 1.5px solid var(--border);
            border-radius: var(--radius);
            color: var(--text-primary);
            font-size: 0.9rem;
            font-family: inherit;
            cursor: pointer;
            appearance: none;
            transition: all 0.2s;
        }

        select:hover {
            border-color: var(--primary-light);
        }

        select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(217, 119, 6, 0.15);
        }

        /* Input */
        input[type="text"], textarea {
            width: 100%;
            padding: 12px 14px;
            background: var(--bg-white);
            border: 1.5px solid var(--border);
            border-radius: var(--radius);
            color: var(--text-primary);
            font-size: 0.9rem;
            font-family: inherit;
            transition: all 0.2s;
        }

        input[type="text"]:hover, textarea:hover {
            border-color: var(--primary-light);
        }

        input[type="text"]:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(217, 119, 6, 0.15);
        }

        input[type="text"]::placeholder, textarea::placeholder {
            color: var(--text-muted);
        }

        /* Divider */
        .divider {
            display: flex;
            align-items: center;
            margin: 24px 0;
            color: var(--text-muted);
            font-size: 0.8rem;
        }

        .divider::before, .divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--border);
        }

        .divider span {
            padding: 0 16px;
        }

        /* Example Tags */
        .example-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .example-tag {
            padding: 6px 12px;
            background: var(--bg-gray);
            border: 1px solid var(--border);
            border-radius: 20px;
            font-size: 0.75rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'JetBrains Mono', monospace;
        }

        .example-tag:hover {
            background: var(--border);
            color: var(--text-primary);
        }

        /* Toggle Switch */
        .toggle-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 0;
            border-top: 1px solid var(--border);
            margin-top: 16px;
        }

        .toggle-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .toggle-label .icon {
            font-size: 1.1rem;
        }

        .toggle-switch {
            position: relative;
            width: 48px;
            height: 26px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #cbd5e1;
            transition: 0.3s;
            border-radius: 26px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
            box-shadow: var(--shadow-sm);
        }

        .toggle-switch input:checked + .toggle-slider {
            background-color: var(--success);
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(22px);
        }

        /* Checkbox Group */
        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 80px;
            padding: 10px 18px;
            background: var(--bg-gray);
            border: 2px solid var(--border);
            border-radius: 25px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--text-secondary);
            transition: all 0.2s;
            user-select: none;
        }

        .checkbox-item:hover {
            border-color: var(--primary-light);
            color: var(--primary);
        }

        .checkbox-item.selected {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        .checkbox-item input {
            display: none;
        }

        /* Language header */
        .lang-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .multi-hint {
            font-size: 0.7rem;
            color: var(--text-muted);
            font-weight: 400;
        }

        /* Language result tabs */
        .lang-tabs {
            display: flex;
            gap: 0;
            margin-bottom: 12px;
            border-bottom: 2px solid var(--border);
        }

        .lang-tab {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 10px 18px;
            font-size: 0.82rem;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            transition: all 0.2s;
            user-select: none;
        }

        .lang-tab:hover {
            color: var(--primary);
        }

        .lang-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
            font-weight: 600;
        }

        .tab-status {
            display: inline-block;
            font-size: 0.7rem;
            line-height: 1;
        }

        .tab-status.done { color: var(--success); }
        .tab-status.generating { color: var(--primary); animation: pulse 1s infinite; }
        .tab-status.error { color: var(--error); }
        .tab-status.pending { color: var(--text-muted); }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        /* Button */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 14px 28px;
            border: none;
            border-radius: var(--radius);
            font-size: 0.9rem;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            box-shadow: var(--shadow-md);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-block {
            width: 100%;
        }

        .btn-secondary {
            background: var(--bg-white);
            color: var(--text-primary);
            border: 1.5px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--bg-gray);
            border-color: var(--primary-light);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-sm {
            padding: 10px 18px;
            font-size: 0.8rem;
        }

        /* Tools Status */
        .tools-grid {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .tool-badge {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .tool-badge.available {
            background: #d1fae5;
            color: #065f46;
        }

        .tool-badge.unavailable {
            background: #fee2e2;
            color: #991b1b;
        }

        /* Result Card */
        .result-card {
            display: none;
            animation: slideUp 0.3s ease;
        }

        .result-card.visible {
            display: block;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .result-header {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: #f0fdf4;
            border-radius: var(--radius);
            margin-bottom: 20px;
        }

        .result-header.error {
            background: #fef2f2;
        }

        .result-header.warning {
            background: #fffbeb;
        }

        .result-header.warning .result-icon {
            background: #f59e0b;
        }

        .result-icon {
            width: 48px;
            height: 48px;
            background: var(--success);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
        }

        .result-header.error .result-icon {
            background: var(--error);
        }

        .result-info h3 {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .result-info p {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        @media (max-width: 640px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .stat-card {
            background: var(--bg-gray);
            padding: 16px;
            border-radius: var(--radius);
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .stat-label {
            font-size: 0.7rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 4px;
        }

        /* Code Preview */
        .code-preview {
            background: #ffffff;
            color: #1e293b;
            border: 1px solid #e2e8f0;
            border-radius: var(--radius);
            padding: 16px;
            font-family: 'JetBrains Mono', 'Fira Code', 'Consolas', monospace;
            font-size: 0.75rem;
            line-height: 1.6;
            overflow-x: auto;
            max-height: 300px;
            white-space: pre-wrap;
            word-break: break-all;
        }

        /* Simulation Output */
        .sim-output {
            background: #0f172a;
            color: #4ade80;
            border-radius: var(--radius);
            padding: 16px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem;
            line-height: 1.6;
            max-height: 350px;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 20px;
            padding-top: 16px;
            border-top: 1px solid var(--border);
        }

        /* Error Message */
        .error-message {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #991b1b;
            padding: 12px 16px;
            border-radius: var(--radius);
            font-size: 0.875rem;
            margin-bottom: 16px;
            display: none;
        }

        .error-message.visible {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Spinner */
        .spinner {
            width: 18px;
            height: 18px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Section Label */
        .section-label {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }

        /* Footer */
        .footer {
            text-align: center;
            padding: 24px;
            color: var(--text-muted);
            font-size: 0.8rem;
        }

        .footer a {
            color: var(--primary);
            text-decoration: none;
        }

        .footer a:hover {
            text-decoration: underline;
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-white);
            border-radius: var(--radius-lg);
            max-width: 600px;
            width: 100%;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow-lg);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
        }

        .modal-header h2 {
            font-size: 1.1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: var(--text-secondary);
            padding: 4px 8px;
            border-radius: 4px;
        }

        .modal-close:hover {
            background: var(--bg-gray);
            color: var(--text-primary);
        }

        .modal-body {
            padding: 24px;
            overflow-y: auto;
            flex: 1;
        }

        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
        }

        .legal-content h3 {
            font-size: 0.95rem;
            font-weight: 600;
            margin: 20px 0 10px 0;
            color: var(--text-primary);
        }

        .legal-content p {
            font-size: 0.85rem;
            color: var(--text-secondary);
            line-height: 1.6;
            margin-bottom: 12px;
        }

        .legal-content a {
            color: var(--primary);
            text-decoration: none;
        }

        .legal-content a:hover {
            text-decoration: underline;
        }

        .legal-content hr {
            border: none;
            border-top: 1px solid var(--border);
            margin: 24px 0;
        }

        /* Authors Footer */
        .authors-section {
            text-align: center;
            padding: 16px;
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .authors-section a {
            color: #10b981;
            text-decoration: none;
            font-weight: 500;
        }

        .authors-section a:hover {
            text-decoration: underline;
        }

        .legal-link {
            color: #10b981;
            cursor: pointer;
            font-size: 0.85rem;
        }

        .legal-link:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <h1>üî¢ MVL Benchmark Generator</h1>
        <p>Generate Multi-Valued Logic ALU Benchmarks using Large Language Models</p>
    </div>

    <div class="container">
        <!-- Tools Status -->
        <div class="card">
            <div class="card-header">
                <div class="card-icon">üîß</div>
                <div>
                    <div class="card-title">System Status</div>
                    <div class="card-subtitle">Available simulation tools</div>
                </div>
            </div>
            <div class="tools-grid" id="tools-status">
                <span class="tool-badge">Checking...</span>
            </div>
        </div>

        <!-- Configuration -->
        <div class="card">
            <div class="card-header">
                <div class="card-icon">‚öôÔ∏è</div>
                <div>
                    <div class="card-title">Configuration</div>
                    <div class="card-subtitle">Set parameters for benchmark generation</div>
                </div>
            </div>

            <!-- Row 1: K-Value and Bitwidth -->
            <div class="form-row">
                 <div class="form-group">
                    <label>Bitwidth (Trits)</label>
                    <div class="select-wrapper">
                        <select id="bitwidth">
                            <option value="8" selected>8-trit</option>
                            <option value="10">10-trit</option>
                            <option value="12">12-trit</option>
                            <option value="14">14-trit</option>
                        </select>
                    </div>
                    <div class="hint">Number of digits in each operand</div>
                </div>
                <div class="form-group">
                    <label>K-Value (Logic Values)</label>
                    <div class="select-wrapper">
                        <select id="k-value">
                            <option value="2">k = 2 (Binary)</option>
                            <option value="3" selected>k = 3 (Ternary / GF(3))</option>
                            <option value="4">k = 4 (Quaternary)</option>
                            <option value="5">k = 5</option>
                            <option value="6">k = 6</option>
                            <option value="7">k = 7</option>
                        </select>
                    </div>
                    <div class="hint">Number of distinct logic values in the system</div>
                </div>
            </div>

            <!-- Row 2: LLM Provider and Model -->
            <div class="form-row">
                <div class="form-group">
                    <label>LLM Provider</label>
                    <div class="select-wrapper">
                        <select id="llm-provider" onchange="onLlmProviderChange()">
                            <option value="gemini" selected>Gemini</option>
                            <option value="groq">Groq</option>
                            <option value="deepseek">DeepSeek</option>
                            <option value="qwen">Qwen</option>
                            <option value="together">Together AI</option>
                            <option value="mistral">Mistral</option>
                            <option value="openai">OpenAI</option>
                            <option value="claude">Claude</option>
                            <option value="grok">Grok</option>
                        </select>
                    </div>
                </div>
                <div class="form-group" id="llm-model-group">
                    <label>Model</label>
                    <div class="select-wrapper">
                        <select id="llm-model">
                        </select>
                    </div>
                </div>
            </div>

            <!-- Row 3: Output Language -->
            <div class="form-group" style="margin-bottom: 20px;">
                <div class="lang-header">
                    <label>Output Language</label>
                    <span class="multi-hint" id="multi-hint">Click to toggle selection</span>
                </div>
                <div class="checkbox-group" id="language-group">
                    <label class="checkbox-item selected" data-value="c">
                        <input type="checkbox" value="c" checked> C
                    </label>
                    <label class="checkbox-item" data-value="python">
                        <input type="checkbox" value="python"> Python
                    </label>
                    <label class="checkbox-item" data-value="verilog">
                        <input type="checkbox" value="verilog"> Verilog
                    </label>
                    <label class="checkbox-item" data-value="vhdl">
                        <input type="checkbox" value="vhdl"> VHDL
                    </label>
                </div>
            </div>

            <!-- Row 4: Operations -->
            <div class="form-group" style="margin-bottom: 0;">
                <label>Operations</label>
                <div class="checkbox-group" id="operations-group">
                    <label class="checkbox-item selected" data-value="ADD">
                        <input type="checkbox" value="ADD" checked> ADD
                    </label>
                    <label class="checkbox-item selected" data-value="SUB">
                        <input type="checkbox" value="SUB" checked> SUB
                    </label>
                    <label class="checkbox-item selected" data-value="MUL">
                        <input type="checkbox" value="MUL" checked> MUL
                    </label>
                    <label class="checkbox-item selected" data-value="NEG">
                        <input type="checkbox" value="NEG" checked> NEG
                    </label>
                    <label class="checkbox-item selected" data-value="INC">
                        <input type="checkbox" value="INC" checked> INC
                    </label>
                    <label class="checkbox-item selected" data-value="DEC">
                        <input type="checkbox" value="DEC" checked> DEC
                    </label>
                    <label class="checkbox-item" data-value="PASSA">
                        <input type="checkbox" value="PASSA"> PASS A
                    </label>
                    <label class="checkbox-item" data-value="PASSB">
                        <input type="checkbox" value="PASSB"> PASS B
                    </label>
                </div>
            </div>

            <!-- Divider -->
            <div class="divider">
                <span>or use natural language</span>
            </div>

            <!-- Natural Language Input -->
            <div class="form-group">
                <label>Natural Language Input</label>
                <input type="text" id="natural-input" placeholder="e.g., 8-trit GF(3) ALU with ADD, SUB, MUL operations">
                <div class="example-tags">
                    <span class="example-tag" onclick="setExample('8-trit GF(3) ALU')">8-trit GF(3) ALU</span>
                    <span class="example-tag" onclick="setExample('10-trit ternary calculator')">10-trit ternary calculator</span>
                    <span class="example-tag" onclick="setExample('quaternary 8-bit multiplier')">quaternary 8-bit multiplier</span>
                    <span class="example-tag" onclick="setExample('GF(5) arithmetic unit')">GF(5) arithmetic unit</span>
                </div>
            </div>

            <!-- Stream Output Toggle -->
            <div class="toggle-row">
                <div class="toggle-label">
                    <span class="icon">‚ö°</span>
                    <span>Stream output</span>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="stream-toggle" checked>
                    <span class="toggle-slider"></span>
                </label>
            </div>
        </div>

        <!-- Error Message -->
        <div class="error-message" id="error-message">
            <span>‚ö†Ô∏è</span>
            <span id="error-text"></span>
        </div>

        <!-- Generate Button -->
        <button class="btn btn-primary btn-block" id="generate-btn" onclick="generate()">
            <span id="generate-btn-text">üöÄ Generate Benchmark</span>
            <div class="spinner" id="generate-spinner" style="display: none;"></div>
        </button>

        <!-- Generation Result -->
        <div class="card result-card" id="generation-result">
            <div class="result-header" id="gen-result-header">
                <div class="result-icon" id="gen-result-icon">‚úì</div>
                <div class="result-info">
                    <h3 id="gen-result-title">Generation Complete</h3>
                    <p id="gen-result-subtitle">mvl_alu_gf3_8bit.c ‚Ä¢ Gemini</p>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="stat-k">3</div>
                    <div class="stat-label">K-Value</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="stat-bits">8</div>
                    <div class="stat-label">Bitwidth</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="stat-mod">6,561</div>
                    <div class="stat-label">MOD Value</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="stat-lang">C</div>
                    <div class="stat-label">Language</div>
                </div>
            </div>

            <div id="validation-warnings" style="display: none; background: #fffbeb; border: 1px solid #fde68a; border-radius: 8px; padding: 12px 16px; margin-bottom: 16px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <div id="validation-warnings-title" style="font-size: 0.8rem; font-weight: 600; color: #92400e;">‚ö†Ô∏è Validation Warnings</div>
                    <button onclick="generate()" style="font-size: 0.72rem; padding: 3px 10px; background: #f59e0b; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">üîÑ Re-generate</button>
                </div>
                <div id="validation-warnings-list" style="font-size: 0.78rem; color: #78350f; margin: 0; line-height: 1.8;"></div>
            </div>

            <div class="section-label">Generated Code Preview</div>
            <div class="lang-tabs" id="result-lang-tabs" style="display: none;"></div>
            <div class="code-preview" id="code-preview">// Loading...</div>

            <div class="action-buttons">
                <button class="btn btn-secondary btn-sm" id="download-code-btn" onclick="downloadCode()">üì• Download Code</button>
                <button class="btn btn-secondary btn-sm" id="download-all-btn" onclick="downloadAll()" style="display: none;">üì¶ Download All (.zip)</button>
                <button class="btn btn-secondary btn-sm" onclick="viewFullCode()">üëÅÔ∏è View Full</button>
                <button class="btn btn-success btn-sm" onclick="runSimulation()" id="run-sim-btn">‚ñ∂Ô∏è Run Simulation</button>
            </div>
        </div>

        <!-- Simulation Result -->
        <div class="card result-card" id="simulation-result">
            <div class="result-header" id="sim-result-header">
                <div class="result-icon">‚úì</div>
                <div class="result-info">
                    <h3 id="sim-result-title">Simulation Complete</h3>
                    <p id="sim-result-subtitle">20 tests executed in 0.12s</p>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="sim-total">20</div>
                    <div class="stat-label">Total Tests</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" style="color: #10b981;" id="sim-passed">20</div>
                    <div class="stat-label">Passed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" style="color: #ef4444;" id="sim-failed">0</div>
                    <div class="stat-label">Failed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="sim-time">0.12s</div>
                    <div class="stat-label">Run Time</div>
                </div>
            </div>

            <div class="section-label">Simulation Output</div>
            <div class="sim-output" id="sim-output">// Loading...</div>

            <div class="action-buttons">
                <button class="btn btn-secondary btn-sm" onclick="downloadLog()">üì• Download Log</button>
                <button class="btn btn-secondary btn-sm" onclick="resetAll()">üîÑ New Generation</button>
            </div>
        </div>
    </div>

<!--    &lt;!&ndash; Footer &ndash;&gt;-->
<!--    <div class="footer">-->
<!--        <p>MVL Benchmark Generator ‚Ä¢ Built for <a href="#">ISMVL 2026</a> Research</p>-->
<!--    </div>-->
    <!-- Footer -->
<div class="footer" style="text-align: center; padding: 24px 0; font-size: 0.95rem;">
    <p style="margin-bottom: 12px; color: #444;">
        Authors:
        <a href="https://de.linkedin.com/in/rolf-drechsler-2304a98"
           target="_blank" rel="noopener noreferrer"
           style="color: teal; text-decoration: none; transition: all 0.2s ease;"
           onmouseover="this.style.textDecoration='underline'; this.style.fontWeight='500'; this.style.opacity='1';"
           onmouseout="this.style.textDecoration='none'; this.style.fontWeight='normal'; this.style.opacity='0.9';">
            Rolf Drechsler
        </a>
        ,
        <a href="https://www.linkedin.com/in/qian-liu-0707482bb/"
           target="_blank" rel="noopener noreferrer"
           style="color: teal; text-decoration: none; transition: all 0.2s ease;"
           onmouseover="this.style.textDecoration='underline'; this.style.fontWeight='500'; this.style.opacity='1';"
           onmouseout="this.style.textDecoration='none'; this.style.fontWeight='normal'; this.style.opacity='0.9';">
            Qian Liu
        </a>
    </p>

    <p>
        <span style="color: teal; text-decoration: none; cursor: pointer; transition: all 0.2s ease;"
              onclick="openLegalModal()"
              onmouseover="this.style.textDecoration='underline'; this.style.opacity='1';"
              onmouseout="this.style.textDecoration='none'; this.style.opacity='0.9';">
            Imprint / Legal Notice
        </span>
    </p>
</div>

    <!-- View Full Code Modal -->
    <div class="modal-overlay" id="code-modal">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh;">
            <div class="modal-header">
                <h2 id="code-modal-title">Full Code</h2>
                <button class="modal-close" onclick="closeCodeModal()">‚úï</button>
            </div>
            <div class="lang-tabs" id="modal-lang-tabs" style="display: none; padding: 0 24px;"></div>
            <div class="modal-body" style="padding: 0;">
                <pre style="margin:0; padding:20px; font-family:'JetBrains Mono','Fira Code','Consolas',monospace; font-size:13px; line-height:1.6; white-space:pre-wrap; word-break:break-all; color:#1e293b; background:#ffffff;" id="code-modal-content"></pre>
            </div>
            <div class="modal-footer" id="code-modal-footer">
                <button class="btn btn-secondary btn-sm" onclick="copyCurrentCode()" id="copy-code-btn">üìã Copy Code</button>
                <button class="btn btn-secondary btn-sm" onclick="downloadCurrentFile()" style="margin-left: 8px;">üì• Download This File</button>
            </div>
        </div>
    </div>

    <!-- Legal Notice Modal -->
    <div class="modal-overlay" id="legal-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìú Imprint / Legal Notice</h2>
                <button class="modal-close" onclick="closeLegalModal()">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="legal-content">

                    <p><strong>Information provided according to ¬ß5 German Telemedia Act (TMG)</strong></p>

                    <h3>Institution</h3>
                    <p>
                        <strong>University of Bremen</strong><br>
                        Faculty 3<br>
                        Group of Computer Architecture (AGRA)<br>
                        Bibliothekstr. 5<br>
                        28359 Bremen<br>
                        Germany
                    </p>

                    <h3>Contact</h3>
                    <p>
                        üìß Email: <a href="mailto:drechsler@uni-bremen.de">drechsler@uni-bremen.de</a><br>
                        üìß Email: <a href="mailto:treebush302@gmail.com">treebush302@gmail.com</a><br>
                    </p>

                    <h3>Responsible for Content (according to ¬ß55(2) RStV)</h3>
                    <p>
                        Prof. Dr. Rolf Drechsler<br>
                        Qian Liu<br>
                    </p>

                    <h3>Research Disclaimer</h3>
                    <p>
                        This website and the associated tools are provided exclusively for academic research and
                        educational purposes.
                        The generated specifications, test scenarios, verification artifacts, and source code are
                        experimental in nature
                        and are provided without any warranty. They must not be used in safety-critical or production
                        environments without
                        independent verification and validation.
                    </p>

                    <h3>Liability for Content</h3>
                    <p>
                        As a service provider, we are responsible for our own content on these pages in accordance with
                        general laws (¬ß7(1) TMG).
                        However, according to ¬ß¬ß8‚Äì10 TMG, we are not obliged to monitor transmitted or stored
                        third-party information or to investigate
                        circumstances that indicate illegal activity. Liability is only possible from the time of
                        knowledge of a concrete infringement.
                        Upon becoming aware of such violations, we will remove the affected content immediately.
                    </p>

                    <h3>Liability for Links (GitHub / arXiv)</h3>
                    <p>
                        This website contains links to external third-party platforms, in particular GitHub (code
                        repositories) and arXiv (scientific publications),
                        over whose content we have no control. Therefore, we cannot assume any liability for these
                        external contents.
                        The respective platform operators are solely responsible for the content of the linked pages.
                        At the time of linking, no illegal content was identifiable. Continuous monitoring of linked
                        content is not reasonable
                        without specific indications of a legal violation. Upon notification of violations, such links
                        will be removed immediately.
                    </p>

                    <h3>Copyright</h3>
                    <p>
                        ¬© 2026 University of Bremen, Group of Computer Architecture (AGRA).<br>
                        All rights reserved.
                    </p>

                    <hr>

                    <h2>üîí Privacy Policy (Datenschutzerkl√§rung)</h2>

                    <h3>General Information</h3>
                    <p>
                        This website is a non-commercial academic research project operated by the University of Bremen,
                        Group of Computer Architecture (AGRA).
                    </p>

                    <h3>Access Data and Server Logs</h3>
                    <p>
                        When accessing this website, the hosting provider may automatically process technical
                        information such as IP address,
                        browser type, operating system, date and time of access, and referrer URL. This data is
                        processed solely for the purpose
                        of ensuring system security, stability, and error analysis.
                    </p>

                    <h3>Legal Basis</h3>
                    <p>
                        The processing of personal data is carried out in accordance with Art. 6(1)(f) GDPR, based on
                        our legitimate interest
                        in maintaining a secure and reliable academic web service.
                    </p>

                    <h3>External Links (GitHub and arXiv)</h3>
                    <p>
                        This website contains links to external services, including GitHub and arXiv. When clicking on
                        these links, you leave this website.
                        The respective privacy policies of GitHub and arXiv apply. No personal data is transmitted to
                        these platforms by this website itself
                        unless you actively follow the provided links.
                    </p>

                    <h3>Data Retention</h3>
                    <p>
                        Personal data is stored only for as long as necessary to fulfill the purposes described above
                        and in accordance with applicable legal obligations.
                    </p>

                    <h3>Rights of Data Subjects</h3>
                    <p>
                        You have the right to request information about the personal data processed, as well as the
                        right to rectification, erasure,
                        restriction of processing, data portability, and to object to processing, in accordance with
                        Articles 15‚Äì21 GDPR.
                    </p>

                    <h3>Contact for Data Protection</h3>
                    <p>
                        For any questions regarding data protection, please contact:<br>
                        üìß <a href="mailto:treebush302@gmail.com">treebush302@gmail.com</a>
                    </p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="closeLegalModal()">Close</button>
            </div>
        </div>
    </div>



    <script>
        // ============================================================
        // State
        // ============================================================
        let currentResult = null;       // Active single result (for simulation compatibility)
        let currentResults = {};        // Multi-language results: {c: {...}, python: {...}, ...}
        let activeResultLang = null;    // Currently displayed tab language
        let simResult = null;

        // Model options
        const modelOptions = {
            'gemini': [
                {value: 'gemini-3-flash-preview', text: 'Gemini 3 Flash Preview'},
                {value: 'gemini-2.5-flash', text: 'Gemini 2.5 Flash'}
            ],
            'openai': [
                {value: 'gpt-5-mini', text: 'GPT-5 Mini (Recommended)'},
                {value: 'gpt-5', text: 'GPT-5'},
                {value: 'gpt-5.1', text: 'GPT-5.1'}
            ],
            'qwen': [
                {value: 'qwen-coder-plus', text: 'Qwen Coder Plus'},
                {value: 'qwen-max', text: 'Qwen Max'}
            ],
            'mistral': [
                {value: 'codestral-latest', text: 'Codestral'},
                {value: 'mistral-large-latest', text: 'Mistral Large'},
                {value: 'mistral-small-latest', text: 'Mistral Small'}
            ],
            'together': [
                {value: 'meta-llama/Llama-3.3-70B-Instruct-Turbo', text: 'Llama 3.3 70B'},
                {value: 'meta-llama/Llama-4-Maverick-17B-128E-Instruct-FP8', text: 'Llama 4 Maverick'}
            ],
            'claude': [
                {value: 'claude-sonnet-4-20250514', text: 'Claude Sonnet 4'},
                {value: 'claude-3-5-sonnet-20241022', text: 'Claude 3.5 Sonnet'}
            ],
            'grok': [
                {value: 'grok-3-mini', text: 'Grok 3 Mini'},
                {value: 'grok-3', text: 'Grok 3'}
            ]
            // deepseek Âíå groq ‰∏çÈúÄË¶Å model ÈÄâÊã©
        };

        // ============================================================
        // Initialization
        // ============================================================
        document.addEventListener('DOMContentLoaded', () => {
            checkTools();
            setupCheckboxes();
            onLlmProviderChange();
        });

        function setupCheckboxes() {
            // Language group: click to toggle (multi-select)
            document.querySelectorAll('#language-group .checkbox-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    const checkbox = item.querySelector('input');
                    checkbox.checked = !checkbox.checked;
                    item.classList.toggle('selected', checkbox.checked);
                });
            });

            // Operations group: always multi-select (toggle)
            document.querySelectorAll('#operations-group .checkbox-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    const checkbox = item.querySelector('input');
                    checkbox.checked = !checkbox.checked;
                    item.classList.toggle('selected', checkbox.checked);
                });
            });
        }

        function onLlmProviderChange() {
            const llm = document.getElementById('llm-provider').value;
            const group = document.getElementById('llm-model-group');
            const select = document.getElementById('llm-model');

            // DeepSeek Âíå Groq ÈöêËóè Model Ê°Ü
            const hideModelProviders = ['deepseek', 'groq'];

            if (hideModelProviders.includes(llm)) {
                group.style.display = 'none';
            } else if (modelOptions[llm]) {
                select.innerHTML = '';
                modelOptions[llm].forEach(opt => {
                    const o = document.createElement('option');
                    o.value = opt.value;
                    o.textContent = opt.text;
                    select.appendChild(o);
                });
                group.style.display = 'block';
            } else {
                group.style.display = 'none';
            }
        }

        async function checkTools() {
            try {
                const response = await fetch('/api/check-tools');
                const data = await response.json();

                const container = document.getElementById('tools-status');
                container.innerHTML = '';

                const tools = [
                    { name: 'GCC (C)', key: 'gcc' },
                    { name: 'Python', key: 'python' },
                    { name: 'Icarus Verilog', key: 'iverilog' }
                ];

                tools.forEach(tool => {
                    const available = data.tools && data.tools[tool.key];
                    const badge = document.createElement('span');
                    badge.className = `tool-badge ${available ? 'available' : 'unavailable'}`;
                    badge.innerHTML = `${available ? '‚úì' : '‚úó'} ${tool.name}`;
                    container.appendChild(badge);
                });

            } catch (error) {
                console.error('Failed to check tools:', error);
                document.getElementById('tools-status').innerHTML =
                    '<span class="tool-badge unavailable">‚ö†Ô∏è Failed to check tools</span>';
            }
        }

        // ============================================================
        // Natural Language Examples
        // ============================================================
        function setExample(text) {
            document.getElementById('natural-input').value = text;
            parseAndSyncNaturalInput(text);
        }

        /**
         * Parse k_value and bitwidth from natural language text.
         * Mirrors the backend _parse_natural_input logic.
         */
        function parseNaturalInput(text) {
            const lower = text.toLowerCase();
            let kValue = null;
            let bitwidth = null;

            // Parse k_value: GF(N)
            let m = lower.match(/gf\s*\(\s*(\d+)\s*\)/);
            if (m) kValue = parseInt(m[1]);

            // Named radixes (word boundary)
            if (kValue === null) {
                const radixMap = {
                    'binary': 2, 'ternary': 3, 'quaternary': 4,
                    'quinary': 5, 'senary': 6, 'septenary': 7, 'octal': 8
                };
                for (const [name, k] of Object.entries(radixMap)) {
                    if (new RegExp('\\b' + name + '\\b').test(lower)) {
                        kValue = k;
                        break;
                    }
                }
            }

            // k=N or k-value N
            if (kValue === null) {
                m = lower.match(/k\s*[-=:]\s*(?:value\s*)?(\d+)/);
                if (m) kValue = parseInt(m[1]);
            }

            // Parse bitwidth: N-trit or N trit
            m = lower.match(/(\d+)\s*-?\s*trit/);
            if (m) bitwidth = parseInt(m[1]);

            // N-bit or N bit
            if (bitwidth === null) {
                m = lower.match(/(\d+)\s*-?\s*bit/);
                if (m) bitwidth = parseInt(m[1]);
            }

            return { kValue, bitwidth };
        }

        /**
         * When natural input changes, sync the dropdown values and update stats.
         */
        function parseAndSyncNaturalInput(text) {
            if (!text.trim()) return;
            const parsed = parseNaturalInput(text);

            if (parsed.kValue !== null) {
                const kSelect = document.getElementById('k-value');
                // Set dropdown if the value exists as an option
                for (const opt of kSelect.options) {
                    if (parseInt(opt.value) === parsed.kValue) {
                        kSelect.value = parsed.kValue;
                        break;
                    }
                }
            }

            if (parsed.bitwidth !== null) {
                const bitsSelect = document.getElementById('bitwidth');
                for (const opt of bitsSelect.options) {
                    if (parseInt(opt.value) === parsed.bitwidth) {
                        bitsSelect.value = parsed.bitwidth;
                        break;
                    }
                }
            }
        }

        // Real-time: update dropdowns as user types natural input
        document.getElementById('natural-input').addEventListener('input', function() {
            parseAndSyncNaturalInput(this.value);
        });

        // ============================================================
        // Generation
        // ============================================================
        let generatedLanguages = [];    // All languages requested in current generation
        let langStatus = {};            // Per-language status: 'pending'|'generating'|'done'|'error'

        function getSelectedItems(groupId) {
            const selected = [];
            document.querySelectorAll(`#${groupId} .checkbox-item.selected`).forEach(item => {
                selected.push(item.dataset.value);
            });
            return selected;
        }

        async function generate() {
            const provider = document.getElementById('llm-provider').value;
            const modelGroup = document.getElementById('llm-model-group');
            const model = modelGroup.style.display !== 'none' ? document.getElementById('llm-model').value : null;
            const kValue = parseInt(document.getElementById('k-value').value);
            const bitwidth = parseInt(document.getElementById('bitwidth').value);
            const languages = getSelectedItems('language-group');
            const operations = getSelectedItems('operations-group');
            const naturalInput = document.getElementById('natural-input').value.trim();
            const streamOutput = document.getElementById('stream-toggle').checked;

            if (languages.length === 0) {
                showError('Please select at least one output language');
                return;
            }

            if (operations.length === 0) {
                showError('Please select at least one operation');
                return;
            }

            // When natural input is provided, parse and override k/bitwidth
            let effectiveK = kValue;
            let effectiveBits = bitwidth;
            if (naturalInput) {
                const parsed = parseNaturalInput(naturalInput);
                if (parsed.kValue !== null) effectiveK = parsed.kValue;
                if (parsed.bitwidth !== null) effectiveBits = parsed.bitwidth;
            }

            hideError();
            setLoading(true);
            currentResults = {};
            activeResultLang = null;
            generatedLanguages = [...languages];
            langStatus = {};
            languages.forEach(l => langStatus[l] = 'pending');

            const baseRequest = {
                llm: provider,
                model: model,
                k_value: effectiveK,
                bitwidth: effectiveBits,
                operations: operations,
                natural_input: naturalInput,
                stream: streamOutput
            };

            // Show result panel with generating state
            document.getElementById('generation-result').classList.add('visible');
            document.getElementById('simulation-result').classList.remove('visible');
            document.getElementById('gen-result-icon').innerHTML = '<div class="spinner"></div>';
            document.getElementById('gen-result-title').textContent = 'Generating...';
            document.getElementById('gen-result-subtitle').textContent = `${provider.toUpperCase()} ‚Ä¢ ${languages.map(l => l.toUpperCase()).join(', ')}`;

            // Update stats with effective values (parsed from natural input or dropdown)
            document.getElementById('stat-k').textContent = effectiveK;
            document.getElementById('stat-bits').textContent = effectiveBits;
            document.getElementById('stat-mod').textContent = (effectiveK ** effectiveBits).toLocaleString();
            document.getElementById('stat-lang').textContent = languages.map(l => l.toUpperCase()).join(', ');

            // Show tabs immediately (with pending status) for multi-language
            activeResultLang = languages[0];
            renderResultTabs();
            document.getElementById('code-preview').textContent = '';

            const errors = [];

            for (let i = 0; i < languages.length; i++) {
                const lang = languages[i];
                const requestBody = { ...baseRequest, language: lang };

                langStatus[lang] = 'generating';
                activeResultLang = lang;
                renderResultTabs();

                // Update header progress
                if (languages.length > 1) {
                    document.getElementById('gen-result-title').textContent =
                        `Generating ${lang.toUpperCase()}... (${i + 1}/${languages.length})`;
                }

                try {
                    if (streamOutput) {
                        await generateStreamOne(requestBody);
                    } else {
                        await generateNormalOne(requestBody);
                    }
                    langStatus[lang] = 'done';
                } catch (error) {
                    console.error(`Generation failed for ${lang}:`, error);
                    langStatus[lang] = 'error';
                    errors.push(`${lang.toUpperCase()}: ${error.message}`);
                }

                renderResultTabs();
            }

            // Display final results
            const successLangs = languages.filter(l => currentResults[l]);

            if (successLangs.length > 0) {
                activeResultLang = successLangs[0];
                currentResult = currentResults[activeResultLang];
                displayFinalResult(successLangs);
            } else {
                document.getElementById('gen-result-icon').textContent = '‚úó';
                document.getElementById('gen-result-title').textContent = 'Generation Failed';
            }

            if (errors.length > 0) {
                showError(`Failed: ${errors.join('; ')}`);
            }

            setLoading(false);
        }

        function renderResultTabs() {
            const container = document.getElementById('result-lang-tabs');
            const isMulti = generatedLanguages.length > 1;

            if (!isMulti) {
                container.style.display = 'none';
                return;
            }

            container.innerHTML = '';
            container.style.display = 'flex';

            generatedLanguages.forEach(lang => {
                const tab = document.createElement('span');
                tab.className = 'lang-tab' + (lang === activeResultLang ? ' active' : '');

                const status = langStatus[lang] || 'pending';
                const statusIcon = status === 'done' ? '‚úì' :
                                   status === 'generating' ? '‚óè' :
                                   status === 'error' ? '‚úó' : '‚óã';

                tab.innerHTML = `${lang.toUpperCase()} <span class="tab-status ${status}">${statusIcon}</span>`;

                if (status === 'done') {
                    tab.onclick = () => switchResultTab(lang);
                }

                container.appendChild(tab);
            });
        }

        async function generateNormalOne(requestBody) {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 180000);

            try {
                const response = await fetch('/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody),
                    signal: controller.signal
                });

                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error || `Generation failed for ${requestBody.language}`);
                }

                currentResults[requestBody.language] = data;

                // Update preview
                const lines = data.code.split('\n').slice(0, 50);
                document.getElementById('code-preview').textContent = lines.join('\n');
                if (data.code.split('\n').length > 50) {
                    document.getElementById('code-preview').textContent += '\n\n// ... (truncated)';
                }
            } finally {
                clearTimeout(timeoutId);
            }
        }

        async function generateStreamOne(requestBody) {
            const preview = document.getElementById('code-preview');
            preview.textContent = '';

            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 180000);

            try {
                const response = await fetch('/api/generate-stream', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody),
                    signal: controller.signal
                });

                if (!response.ok) {
                    const errData = await response.json();
                    throw new Error(errData.error || 'Stream request failed');
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                let streamedText = '';

                function processSSELine(line) {
                    if (!line.startsWith('data: ')) return;
                    try {
                        const eventData = JSON.parse(line.slice(6));

                        if (eventData.type === 'chunk') {
                            streamedText += eventData.content;
                            const allLines = streamedText.split('\n');
                            const displayLines = allLines.slice(0, 50);
                            preview.textContent = displayLines.join('\n');
                            if (allLines.length > 50) {
                                preview.textContent += '\n\n// ... (streaming)';
                            }
                            preview.scrollTop = preview.scrollHeight;

                        } else if (eventData.type === 'done') {
                            currentResults[requestBody.language] = eventData.result;

                        } else if (eventData.type === 'error') {
                            console.error(`Stream error for ${requestBody.language}:`, eventData.error);
                        }
                    } catch (parseErr) {
                        // Ignore JSON parse errors from incomplete chunks
                    }
                }

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop();

                    for (const line of lines) {
                        processSSELine(line);
                    }
                }

                // Process remaining buffer
                if (buffer.trim()) {
                    processSSELine(buffer);
                }

                // If 'done' event was missed, the result won't be stored
                // The caller will detect this via langStatus
            } finally {
                clearTimeout(timeoutId);
            }
        }

        function displayFinalResult(languages) {
            const isMulti = languages.length > 1;

            document.getElementById('gen-result-icon').textContent = '‚úì';
            document.getElementById('gen-result-title').textContent = 'Generation Complete';

            if (isMulti) {
                const llm = currentResults[languages[0]]?.llm || '';
                document.getElementById('gen-result-subtitle').textContent =
                    `${languages.length} files generated ‚Ä¢ ${llm.toUpperCase()}`;

                document.getElementById('download-all-btn').style.display = '';
                document.getElementById('download-code-btn').textContent = 'üì• Download This File';
            } else {
                const data = currentResults[languages[0]];
                document.getElementById('gen-result-subtitle').textContent =
                    `${data.filename} ‚Ä¢ ${data.llm.toUpperCase()}`;
                document.getElementById('download-all-btn').style.display = 'none';
                document.getElementById('download-code-btn').textContent = 'üì• Download Code';
            }

            // Update tabs with final status
            generatedLanguages = languages;
            renderResultTabs();
            showResultForLang(activeResultLang);
        }

        function switchResultTab(lang) {
            activeResultLang = lang;
            currentResult = currentResults[lang];
            renderResultTabs();
            showResultForLang(lang);
        }

        function showResultForLang(lang) {
            const data = currentResults[lang];
            if (!data) return;

            currentResult = data;

            document.getElementById('stat-k').textContent = data.k_value;
            document.getElementById('stat-bits').textContent = data.bitwidth;
            document.getElementById('stat-mod').textContent = data.mod_value.toLocaleString();
            // Show all generated languages, not just the active tab
            document.getElementById('stat-lang').textContent = generatedLanguages.map(l => l.toUpperCase()).join(', ');

            // Show validation warnings with actionable suggestions
            const warningsBox = document.getElementById('validation-warnings');
            const warningsList = document.getElementById('validation-warnings-list');
            const warningsTitle = document.getElementById('validation-warnings-title');
            const resultHeader = document.getElementById('gen-result-header');
            const resultIcon = document.getElementById('gen-result-icon');
            const resultTitle = document.getElementById('gen-result-title');

            const suggestionMap = {
                'LANGUAGE MISMATCH': 'Try re-generating. If the issue persists, switch to a different AI provider.',
                'MISSING OPERATION': 'Re-generate to include all 6 MVL operations (ADD, SUB, MUL, NEG, INC, DEC). A different provider may produce better results.',
                'MOD VALUE': 'The modular arithmetic constant may be incorrect. Re-generate or manually add the correct mod value to the code.',
                'BIT WIDTH': 'The data bit width doesn\'t match log\u2082(mod). Re-generate or manually correct the bit width declarations.',
                'LOW TEST COVERAGE': 'Re-generate for more test vectors, or manually add test cases to improve verification coverage.',
                'OVERFLOW RISK': 'Replace uint32_t with uint64_t for multiplication operations to prevent integer overflow.',
            };

            if (data.validation_warnings && data.validation_warnings.length > 0) {
                warningsTitle.textContent = `‚ö†Ô∏è Validation Warnings (${data.validation_warnings.length})`;
                warningsList.innerHTML = data.validation_warnings
                    .map(w => {
                        const escaped = escapeHtml(w);
                        const type = w.split(':')[0].trim();
                        const suggestion = suggestionMap[type] || 'Try re-generating with a different AI provider.';
                        return `<div style="margin-bottom: 8px; padding: 6px 10px; background: #fef3c7; border-radius: 4px;">
                            <div style="font-weight: 500;">‚ö† ${escaped}</div>
                            <div style="font-size: 0.72rem; color: #92400e; margin-top: 2px;">üí° ${escapeHtml(suggestion)}</div>
                        </div>`;
                    })
                    .join('');
                warningsBox.style.display = 'block';
                // Change header to amber/warning state
                resultHeader.className = 'result-header warning';
                resultIcon.textContent = '‚ö†';
                resultTitle.textContent = 'Generation Complete (with warnings)';
            } else {
                warningsBox.style.display = 'none';
                // Restore green success state
                resultHeader.className = 'result-header';
                resultIcon.textContent = '‚úì';
                resultTitle.textContent = 'Generation Complete';
            }

            // Code preview (first 50 lines)
            const allLines = data.code.split('\n');
            const displayLines = allLines.slice(0, 50);
            let previewText = displayLines.join('\n');
            if (allLines.length > 50) {
                previewText += '\n\n// ... (truncated)';
            }
            document.getElementById('code-preview').textContent = previewText;
        }

        // ============================================================
        // Simulation
        // ============================================================
        async function runSimulation() {
            // Use active tab result
            const result = currentResults[activeResultLang] || currentResult;
            if (!result) {
                showError('No code to simulate');
                return;
            }
            currentResult = result;

            const btn = document.getElementById('run-sim-btn');
            btn.disabled = true;
            btn.innerHTML = '<div class="spinner"></div> Running...';

            try {
                const response = await fetch('/api/run-simulation', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        file_path: currentResult.file_path,
                        language: currentResult.language
                    })
                });

                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.errors?.join(', ') || data.error || 'Simulation failed');
                }

                simResult = data;
                displaySimResult(data);

            } catch (error) {
                showError(error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '‚ñ∂Ô∏è Run Simulation';
            }
        }

        function displaySimResult(data) {
            document.getElementById('sim-result-title').textContent = 'Simulation Complete';
            document.getElementById('sim-result-subtitle').textContent =
                `${data.test_results.total} tests executed in ${data.run_time}s`;

            document.getElementById('sim-total').textContent = data.test_results.total;
            document.getElementById('sim-passed').textContent = data.test_results.passed;
            document.getElementById('sim-failed').textContent = data.test_results.failed;
            document.getElementById('sim-time').textContent = `${data.run_time}s`;

            document.getElementById('sim-output').textContent = data.output || 'No output';

            document.getElementById('simulation-result').classList.add('visible');
        }

        // ============================================================
        // Actions
        // ============================================================
        function downloadCode() {
            const result = currentResults[activeResultLang] || currentResult;
            if (result?.file_path) {
                window.location.href = `/api/download/${result.file_path}`;
            }
        }

        function downloadCurrentFile() {
            downloadCode();
        }

        function downloadAll() {
            const filePaths = Object.values(currentResults)
                .filter(r => r?.file_path)
                .map(r => r.file_path);

            if (filePaths.length === 0) return;

            if (filePaths.length === 1) {
                window.location.href = `/api/download/${filePaths[0]}`;
                return;
            }

            // POST to zip endpoint
            fetch('/api/download-zip', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ file_paths: filePaths })
            })
            .then(response => response.blob())
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'mvl_benchmark_codes.zip';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            })
            .catch(err => showError('Download failed: ' + err.message));
        }

        function downloadLog() {
            if (simResult?.log_file) {
                window.location.href = `/api/download/${simResult.log_file}`;
            }
        }

        let modalActiveLang = null;

        function viewFullCode() {
            const result = currentResults[activeResultLang] || currentResult;
            if (!result?.code) return;

            modalActiveLang = activeResultLang;
            const isMulti = generatedLanguages.length > 1 &&
                            generatedLanguages.filter(l => currentResults[l]).length > 1;

            // Build modal tabs for multi-language
            const modalTabs = document.getElementById('modal-lang-tabs');
            if (isMulti) {
                modalTabs.innerHTML = '';
                modalTabs.style.display = 'flex';
                generatedLanguages.forEach(lang => {
                    if (!currentResults[lang]) return;
                    const tab = document.createElement('span');
                    tab.className = 'lang-tab' + (lang === modalActiveLang ? ' active' : '');
                    tab.textContent = lang.toUpperCase();
                    tab.onclick = () => switchModalTab(lang);
                    modalTabs.appendChild(tab);
                });
            } else {
                modalTabs.style.display = 'none';
            }

            updateModalContent(modalActiveLang);
            document.getElementById('code-modal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function switchModalTab(lang) {
            modalActiveLang = lang;
            document.querySelectorAll('#modal-lang-tabs .lang-tab').forEach(tab => {
                tab.classList.toggle('active', tab.textContent === lang.toUpperCase());
            });
            updateModalContent(lang);
        }

        function updateModalContent(lang) {
            const data = currentResults[lang];
            if (!data) return;
            document.getElementById('code-modal-title').textContent = data.filename || 'Full Code';
            document.getElementById('code-modal-content').textContent = data.code;
        }

        function copyCurrentCode() {
            const data = currentResults[modalActiveLang || activeResultLang];
            if (!data?.code) return;

            navigator.clipboard.writeText(data.code).then(() => {
                const btn = document.getElementById('copy-code-btn');
                const original = btn.textContent;
                btn.textContent = '‚úì Copied!';
                setTimeout(() => { btn.textContent = original; }, 2000);
            }).catch(() => {
                showError('Failed to copy to clipboard');
            });
        }

        function closeCodeModal() {
            document.getElementById('code-modal').classList.remove('active');
            document.body.style.overflow = '';
        }

        function resetAll() {
            currentResult = null;
            currentResults = {};
            activeResultLang = null;
            generatedLanguages = [];
            langStatus = {};
            simResult = null;
            document.getElementById('generation-result').classList.remove('visible');
            document.getElementById('simulation-result').classList.remove('visible');
            document.getElementById('result-lang-tabs').style.display = 'none';
            document.getElementById('download-all-btn').style.display = 'none';
        }

        // ============================================================
        // Utilities
        // ============================================================
        function setLoading(loading) {
            const btn = document.getElementById('generate-btn');

            btn.disabled = loading;

            if (loading) {
                btn.innerHTML = '<div class="spinner"></div> Generating...';
            } else {
                btn.innerHTML = '<span id="generate-btn-text">üöÄ Generate Benchmark</span>';
            }
        }

        function showError(message) {
            const container = document.getElementById('error-message');
            document.getElementById('error-text').textContent = message;
            container.classList.add('visible');
        }

        function hideError() {
            document.getElementById('error-message').classList.remove('visible');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        // ============================================================
        // Legal Modal
        // ============================================================
        function openLegalModal() {
            document.getElementById('legal-modal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeLegalModal() {
            document.getElementById('legal-modal').classList.remove('active');
            document.body.style.overflow = '';
        }

        // Close modal when clicking outside
        document.addEventListener('click', (e) => {
            if (e.target === document.getElementById('legal-modal')) {
                closeLegalModal();
            }
            if (e.target === document.getElementById('code-modal')) {
                closeCodeModal();
            }
        });

        // Close modal with Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeLegalModal();
                closeCodeModal();
            }
        });
    </script>
</body>
</html>